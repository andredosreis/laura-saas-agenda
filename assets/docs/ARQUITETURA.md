# ðŸ—ï¸ ARQUITETURA - LAURA SAAS AGENDA

**VersÃ£o:** 1.0.0
**Data:** 16 de Novembro de 2025
**Status:** ImplementaÃ§Ã£o Parcial (MVP em ProduÃ§Ã£o Beta)

---

## ðŸ“‘ Ãndice

1. [VisÃ£o Geral](#1-visÃ£o-geral)
2. [Diagrama de Arquitetura](#2-diagrama-de-arquitetura)
3. [Camadas da AplicaÃ§Ã£o](#3-camadas-da-aplicaÃ§Ã£o)
4. [Fluxos de Dados](#4-fluxos-de-dados)
5. [IntegraÃ§Ãµes Externas](#5-integraÃ§Ãµes-externas)
6. [DecisÃµes Arquiteturais](#6-decisÃµes-arquiteturais)
7. [Escalabilidade](#7-escalabilidade)
8. [SeguranÃ§a](#8-seguranÃ§a)
9. [Performance](#9-performance)
10. [Monitoramento](#10-monitoramento)

---

## 1. VisÃ£o Geral

### 1.1 DescriÃ§Ã£o

**LAURA SAAS AGENDA** Ã© um sistema completo de gestÃ£o de agendamentos para estÃ©tica, com foco em automaÃ§Ã£o via chatbot WhatsApp com IA e notificaÃ§Ãµes inteligentes.

### 1.2 Tipo de Arquitetura

**Monolito Modular Full-Stack com IntegraÃ§Ã£o de IA**

- **Frontend:** Progressive Web App (PWA) em React
- **Backend:** API REST em Node.js/Express
- **Database:** MongoDB Atlas (NoSQL)
- **IA:** OpenAI GPT-4o-mini (Function Calling)
- **Messaging:** Z-API WhatsApp + Web Push

### 1.3 CaracterÃ­sticas Principais

- âœ… **Event-Driven (Parcial)**: Webhooks Z-API + CRON jobs
- âœ… **Offline-First**: PWA com Service Worker
- âœ… **IA Conversacional**: Chatbot com LLM
- âœ… **Dual-Channel Notifications**: WhatsApp + Web Push
- âœ… **Real-Time Updates**: Polling (futuro: WebSockets)

---

## 2. Diagrama de Arquitetura

### 2.1 Arquitetura de Alto NÃ­vel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       LAURA SAAS - ECOSSISTEMA COMPLETO                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CLIENTE                  â”‚
â”‚    (WhatsApp Business)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ Mensagens
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   Z-API     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  (Webhook)  â”‚                  â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
             â”‚                         â”‚
             â”‚ POST /webhook/whatsapp  â”‚
             â–¼                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            BACKEND (Node.js + Express)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Controllers  â”‚ â—„â”€â”€â–º â”‚   Services   â”‚ â—„â”€â”€â–º â”‚   Models     â”‚           â”‚
â”‚  â”‚               â”‚      â”‚              â”‚      â”‚  (Mongoose)  â”‚           â”‚
â”‚  â”‚  - Agente     â”‚      â”‚ - LLM Agent  â”‚      â”‚              â”‚           â”‚
â”‚  â”‚  - Dashboard  â”‚      â”‚ - Function   â”‚      â”‚ - Cliente    â”‚           â”‚
â”‚  â”‚  - WhatsApp   â”‚      â”‚   Dispatcher â”‚      â”‚ - Agendamentoâ”‚           â”‚
â”‚  â”‚  - Webhook    â”‚      â”‚ - Push       â”‚      â”‚ - Pacote     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚                      â”‚                      â”‚                    â”‚
â”‚         â”‚                      â–¼                      â–¼                    â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚              â”‚   OpenAI     â”‚      â”‚   MongoDB    â”‚             â”‚
â”‚         â”‚              â”‚ GPT-4o-mini  â”‚      â”‚    Atlas     â”‚             â”‚
â”‚         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                                                  â”‚
â”‚         â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚  â”‚  CRON Jobs   â”‚  (19h diÃ¡rio - Lembretes)                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ REST API
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (React + Vite PWA)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚    Pages     â”‚ â—„â”€â”€â–º â”‚  Components  â”‚ â—„â”€â”€â–º â”‚   Services   â”‚            â”‚
â”‚  â”‚              â”‚      â”‚              â”‚      â”‚              â”‚            â”‚
â”‚  â”‚ - Dashboard  â”‚      â”‚ - Header     â”‚      â”‚ - api.js     â”‚            â”‚
â”‚  â”‚ - Clientes   â”‚      â”‚ - Navbar     â”‚      â”‚ - notificationâ”‚           â”‚
â”‚  â”‚ - Agendamentosâ”‚     â”‚ - InstallPromptâ”‚    â”‚ - offline    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                      â”‚                     â”‚
â”‚                                                      â–¼                     â”‚
â”‚                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                                              â”‚Service Workerâ”‚             â”‚
â”‚                                              â”‚   + Cache    â”‚             â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                      â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚  Web Push    â”‚
                                               â”‚   Service    â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚    LAURA     â”‚
                                               â”‚ (Navegador)  â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.2 Arquitetura de Componentes Backend

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               BACKEND LAYERS                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              PRESENTATION LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Routes                    Middlewares                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ - /api/clientes â”‚      â”‚ - errorHandler    â”‚                            â”‚
â”‚  â”‚ - /api/agendamentosâ”‚    â”‚ - requestLogger   â”‚                            â”‚
â”‚  â”‚ - /api/agente   â”‚      â”‚ - validateObjectIdâ”‚                            â”‚
â”‚  â”‚ - /webhook/whatsappâ”‚    â”‚ - cors            â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             BUSINESS LOGIC LAYER                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Controllers                  Services                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ - agenteControllerâ”‚   â—„â”€â”€â–ºâ”‚ - functionDispatcherâ”‚                        â”‚
â”‚  â”‚ - dashboardControllerâ”‚      â”‚ - openaiHelper     â”‚                        â”‚
â”‚  â”‚ - clienteControllerâ”‚        â”‚ - pushService      â”‚                        â”‚
â”‚  â”‚ - webhookControllerâ”‚        â”‚ - analyticsService â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               DATA ACCESS LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Models (Mongoose ODM)                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ - Cliente (+ Anamnese + HistÃ³rico Conversas)                 â”‚          â”‚
â”‚  â”‚ - Agendamento (+ ConfirmaÃ§Ã£o + Status)                       â”‚          â”‚
â”‚  â”‚ - Pacote                                                      â”‚          â”‚
â”‚  â”‚ - Schedule (Disponibilidade)                                 â”‚          â”‚
â”‚  â”‚ - Conversa (LLM State)                                       â”‚          â”‚
â”‚  â”‚ - UserSubscription (Web Push)                                â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  MongoDB Atlas   â”‚
                          â”‚   (lauraDB)      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.3 Arquitetura de Componentes Frontend

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            FRONTEND ARCHITECTURE                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              PRESENTATION LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Pages                         Components                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚ - Dashboard       â”‚    â—„â”€â”€â–ºâ”‚ - Header          â”‚                         â”‚
â”‚  â”‚ - Clientes        â”‚         â”‚ - Navbar          â”‚                         â”‚
â”‚  â”‚ - Agendamentos    â”‚         â”‚ - Sidebar         â”‚                         â”‚
â”‚  â”‚ - Pacotes         â”‚         â”‚ - InstallPrompt   â”‚                         â”‚
â”‚  â”‚ - Disponibilidade â”‚         â”‚ - ErrorBoundary   â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               SERVICE LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Services                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ - api.js (Axios config + interceptors)                      â”‚           â”‚
â”‚  â”‚ - notificationService.ts (Web Push subscribe/send)          â”‚           â”‚
â”‚  â”‚ - offlineService.ts (IndexedDB queue - parcial)             â”‚           â”‚
â”‚  â”‚ - scheduleService.ts (Disponibilidade API)                  â”‚           â”‚
â”‚  â”‚ - serviceWorkerService.ts (SW lifecycle)                    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 PWA LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Service Worker                  Cache Strategy                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ - Install event  â”‚           â”‚ - Precache staticâ”‚                       â”‚
â”‚  â”‚ - Activate event â”‚           â”‚ - Network first  â”‚                       â”‚
â”‚  â”‚ - Fetch event    â”‚           â”‚ - Cache first    â”‚                       â”‚
â”‚  â”‚ - Push event     â”‚           â”‚ - Stale-while-   â”‚                       â”‚
â”‚  â”‚ - Sync event     â”‚           â”‚   revalidate     â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Camadas da AplicaÃ§Ã£o

### 3.1 Backend Layers

#### 3.1.1 Presentation Layer
**Responsabilidade:** Receber e responder requisiÃ§Ãµes HTTP

**Componentes:**
- **Routes**: DefiniÃ§Ã£o de endpoints REST
- **Middlewares**: ValidaÃ§Ã£o, logging, error handling

**Tecnologias:**
- Express.js
- CORS
- Morgan (logging)

---

#### 3.1.2 Business Logic Layer
**Responsabilidade:** Regras de negÃ³cio e orquestraÃ§Ã£o

**Componentes:**
- **Controllers**: Coordenar lÃ³gica de negÃ³cio
- **Services**: LÃ³gica reutilizÃ¡vel (LLM, push, analytics)

**PadrÃµes:**
- MVC (Model-View-Controller)
- Service Layer Pattern
- Dependency Injection (manual)

---

#### 3.1.3 Data Access Layer
**Responsabilidade:** PersistÃªncia de dados

**Componentes:**
- **Models**: Mongoose schemas
- **Database**: MongoDB Atlas

**PadrÃµes:**
- Repository Pattern (implÃ­cito via Mongoose)
- Active Record Pattern

---

### 3.2 Frontend Layers

#### 3.2.1 Presentation Layer
**Responsabilidade:** UI/UX

**Componentes:**
- **Pages**: Rotas principais
- **Components**: Componentes reutilizÃ¡veis

**Tecnologias:**
- React 19
- React Router DOM
- TailwindCSS

---

#### 3.2.2 Service Layer
**Responsabilidade:** ComunicaÃ§Ã£o com backend e APIs

**Componentes:**
- **api.js**: Axios config
- **notificationService.ts**: Web Push
- **offlineService.ts**: IndexedDB (offline queue)

**PadrÃµes:**
- Facade Pattern (api.js)
- Observer Pattern (notifications)

---

#### 3.2.3 PWA Layer
**Responsabilidade:** Offline-first, cache, push

**Componentes:**
- **Service Worker**: Lifecycle e cache
- **Manifest**: PWA config

**EstratÃ©gias:**
- Precache (static assets)
- Network First (API calls)
- Cache First (images, fonts)

---

## 4. Fluxos de Dados

### 4.1 Fluxo de Agendamento via WhatsApp

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUXO: AGENDAMENTO VIA WHATSAPP                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CLIENTE                Z-API           BACKEND          OPENAI        DATABASE
  â”‚                     â”‚                 â”‚                â”‚              â”‚
  â”‚â”€â”€â”€â”€ "OlÃ¡" â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                â”‚              â”‚
  â”‚                     â”‚                 â”‚                â”‚              â”‚
  â”‚                     â”‚â”€â”€â”€ Webhook â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚
  â”‚                     â”‚ POST /webhook/  â”‚                â”‚              â”‚
  â”‚                     â”‚ whatsapp        â”‚                â”‚              â”‚
  â”‚                     â”‚ {phone, msg}    â”‚                â”‚              â”‚
  â”‚                     â”‚                 â”‚                â”‚              â”‚
  â”‚                     â”‚                 â”‚â”€â”€ Find Cliente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚    by telefone â”‚              â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ null â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚                â”‚              â”‚
  â”‚                     â”‚                 â”‚â”€â”€ Create Conversa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚   {telefone,   â”‚              â”‚
  â”‚                     â”‚                 â”‚    estado:     â”‚              â”‚
  â”‚                     â”‚                 â”‚    'iniciando'}â”‚              â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ conversaId â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚                â”‚              â”‚
  â”‚                     â”‚                 â”‚â”€â”€ chatWithLaura() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚    (systemPrompt + msg)       â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ "Bem-vindo! Nome?" â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚<â”€ "Bem-vindo! Nome?"â”‚<â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚â”€ "JoÃ£o Silva" â”€â”€â”€â”€â”€>â”‚                 â”‚                               â”‚
  â”‚                     â”‚â”€â”€â”€ Webhook â”€â”€â”€â”€â”€>â”‚                               â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ chatWithLaura() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚   (context + "JoÃ£o Silva")    â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ Tool Call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚    create_client              â”‚
  â”‚                     â”‚                 â”‚    {name, phone, dob}         â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ dispatch() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚   functionDispatcher          â”‚
  â”‚                     â”‚                 â”‚   createClientHandler()       â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ Save Cliente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ clientId â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ Update Conversa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚   estado: 'livre'             â”‚
  â”‚                     â”‚                 â”‚   dados.clientId              â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚<â”€ "Qual serviÃ§o?" â”€â”€â”‚<â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚â”€ "Drenagem" â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                               â”‚
  â”‚                     â”‚â”€â”€â”€ Webhook â”€â”€â”€â”€â”€>â”‚                               â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ Find Pacotes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚   categoria: Drenagem         â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ [pacotes] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ Check Schedule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚   dayOfWeek, horÃ¡rios         â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ HorÃ¡rios disponÃ­veis â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚<â”€ "HorÃ¡rios: ..." â”€â”€â”‚<â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚
  â”‚   "Sexta 10h, 14h"  â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚â”€ "Sexta 10h" â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                               â”‚
  â”‚                     â”‚â”€â”€â”€ Webhook â”€â”€â”€â”€â”€>â”‚                               â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ chatWithLaura() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ Tool Call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚    create_appointment         â”‚
  â”‚                     â”‚                 â”‚    {clientId, dateTime}       â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ Save Agendamento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                     â”‚                 â”‚   status: 'Agendado'          â”‚
  â”‚                     â”‚                 â”‚<â”€â”€ appointmentId â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚â”€â”€ Send Web Push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                     â”‚                 â”‚   (para LAURA)                â”‚
  â”‚                     â”‚                 â”‚   "Novo agendamento: JoÃ£o"    â”‚
  â”‚                     â”‚                 â”‚                               â”‚
  â”‚<â”€ "âœ… Confirmado!" â”€â”‚<â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚
  â”‚   "Sexta, 10h"      â”‚                 â”‚                               â”‚
  â”‚                     â”‚                 â”‚                               â”‚
```

**DescriÃ§Ã£o:**
1. Cliente envia mensagem via WhatsApp
2. Z-API recebe e envia webhook para backend
3. Backend busca/cria cliente e conversa
4. LLM (GPT-4o-mini) processa mensagem com Function Calling
5. Function Dispatcher executa aÃ§Ãµes (create_client, create_appointment)
6. Dados salvos no MongoDB
7. Web Push enviado para Laura
8. Resposta enviada ao cliente via Z-API

**Tempo mÃ©dio:** 2-5 segundos

---

### 4.2 Fluxo de Lembretes Automatizados (CRON)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FLUXO: LEMBRETES AUTOMATIZADOS (19h)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CRON (19h)          BACKEND          DATABASE          Z-API       WEB PUSH
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚â”€â”€â”€ Trigger â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                â”‚             â”‚
  â”‚   (19:00 diÃ¡rio)  â”‚                  â”‚                â”‚             â”‚
  â”‚   timezone:       â”‚                  â”‚                â”‚             â”‚
  â”‚   Europe/Lisbon   â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚â”€â”€ Find Agendamentos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
  â”‚                   â”‚   date: tomorrow â”‚                â”‚             â”‚
  â”‚                   â”‚   status: [      â”‚                â”‚             â”‚
  â”‚                   â”‚    'Agendado',   â”‚                â”‚             â”‚
  â”‚                   â”‚    'Confirmado'  â”‚                â”‚             â”‚
  â”‚                   â”‚   ]              â”‚                â”‚             â”‚
  â”‚                   â”‚<â”€â”€ [3 agendamentos] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚   FOR EACH agendamento:           â”‚             â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚â”€â”€ Populate cliente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
  â”‚                   â”‚<â”€â”€ cliente.nome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
  â”‚                   â”‚    cliente.telefone              â”‚             â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚â”€â”€ Send WhatsApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ â”‚
  â”‚                   â”‚    (para CLIENTE)â”‚                â”‚             â”‚
  â”‚                   â”‚    "OlÃ¡ JoÃ£o,    â”‚                â”‚             â”‚
  â”‚                   â”‚     lembrete:    â”‚                â”‚             â”‚
  â”‚                   â”‚     amanhÃ£ 10h"  â”‚                â”‚             â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚â”€â”€ Find UserSubscription â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
  â”‚                   â”‚   userId: 'LAURA'â”‚                â”‚             â”‚
  â”‚                   â”‚<â”€â”€ subscription â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚â”€â”€ sendPushNotification() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                   â”‚    (para LAURA)  â”‚                â”‚             â”‚
  â”‚                   â”‚    "Lembrete enviado para JoÃ£o"  â”‚             â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚<â”€â”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
  â”‚<â”€â”€ Log Result â”€â”€â”€â”€â”‚   {sent: 6, failed: 0}           â”‚             â”‚
  â”‚    (console.log)  â”‚                  â”‚                â”‚             â”‚
  â”‚                   â”‚                  â”‚                â”‚             â”‚
```

**DescriÃ§Ã£o:**
1. CRON trigger Ã s 19h (Europe/Lisbon)
2. Buscar agendamentos do dia seguinte (status: Agendado/Confirmado)
3. Para cada agendamento:
   - Enviar WhatsApp para CLIENTE (confirmaÃ§Ã£o)
   - Enviar Web Push para LAURA (notificaÃ§Ã£o interna)
4. Logar resultados (enviados/falhados)

**FrequÃªncia:** DiÃ¡ria (19:00)
**Tempo mÃ©dio:** 1-3 minutos (depende do volume)

---

### 4.3 Fluxo de InstalaÃ§Ã£o PWA + Web Push

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FLUXO: INSTALAÃ‡ÃƒO PWA + WEB PUSH                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BROWSER            SERVICE WORKER       FRONTEND          BACKEND
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚â”€â”€â”€ Visita site â”€â”€â”€â”€â”€>â”‚                  â”‚                 â”‚
  â”‚   (primeira vez)     â”‚                  â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚â”€â”€â”€ Register â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                      â”‚    navigator     â”‚                 â”‚
  â”‚                      â”‚    .serviceWorkerâ”‚                 â”‚
  â”‚                      â”‚    .register()   â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚<â”€â”€ SW instalado â”€â”‚                 â”‚
  â”‚                      â”‚    (install      â”‚                 â”‚
  â”‚                      â”‚     event)       â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚â”€â”€â”€ Activate â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                      â”‚    (cache setup) â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚<â”€ Prompt instalaÃ§Ã£o â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
  â”‚   "Instalar app?"    â”‚  (InstallPrompt) â”‚                 â”‚
  â”‚   (beforeinstallprompt)                 â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚â”€â”€â”€ UsuÃ¡rio aceita â”€â”€>â”‚                  â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚â”€â”€â”€ Install â”€â”€â”€â”€â”€>â”‚                 â”‚
  â”‚                      â”‚    (add to       â”‚                 â”‚
  â”‚                      â”‚     home screen) â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚<â”€ App instalado â”€â”€â”€â”€â”€â”‚                  â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚â”€â”€â”€ Pede permissÃ£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚<â”€ "Permitir notif?" â”€â”‚    Notification  â”‚                 â”‚
  â”‚                      â”‚    .requestPermission()            â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚â”€â”€â”€ Concede â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                 â”‚
  â”‚   (granted)          â”‚                  â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚â”€â”€â”€ Subscribe â”€â”€â”€>â”‚                 â”‚
  â”‚                      â”‚    serviceWorker â”‚                 â”‚
  â”‚                      â”‚    .pushManager  â”‚                 â”‚
  â”‚                      â”‚    .subscribe({  â”‚                 â”‚
  â”‚                      â”‚     VAPID_KEY    â”‚                 â”‚
  â”‚                      â”‚    })            â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚<â”€â”€ subscription â”€â”‚                 â”‚
  â”‚                      â”‚    {endpoint,    â”‚                 â”‚
  â”‚                      â”‚     keys: {      â”‚                 â”‚
  â”‚                      â”‚      auth, p256dhâ”‚                 â”‚
  â”‚                      â”‚     }}           â”‚                 â”‚
  â”‚                      â”‚                  â”‚                 â”‚
  â”‚                      â”‚                  â”‚â”€â”€ POST /subscribe â”€â”€â”€â”€â”€>â”‚
  â”‚                      â”‚                  â”‚   {userId: 'LAURA',     â”‚
  â”‚                      â”‚                  â”‚    endpoint,            â”‚
  â”‚                      â”‚                  â”‚    keys}                â”‚
  â”‚                      â”‚                  â”‚                         â”‚
  â”‚                      â”‚                  â”‚<â”€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                      â”‚                  â”‚                         â”‚
  â”‚                      â”‚                  â”‚                         â”‚
  â”‚   [LATER: Novo agendamento criado]     â”‚                         â”‚
  â”‚                      â”‚                  â”‚                         â”‚
  â”‚                      â”‚<â”€ Push event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                      â”‚   (payload:      â”‚                         â”‚
  â”‚                      â”‚    novo agendamento)                       â”‚
  â”‚                      â”‚                  â”‚                         â”‚
  â”‚<â”€ NotificaÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                         â”‚
  â”‚   ðŸ”” "JoÃ£o - 10h"    â”‚                  â”‚                         â”‚
  â”‚                      â”‚                  â”‚                         â”‚
```

**DescriÃ§Ã£o:**
1. UsuÃ¡rio visita site
2. Service Worker registrado
3. Prompt de instalaÃ§Ã£o exibido (InstallPrompt component)
4. UsuÃ¡rio aceita instalaÃ§Ã£o
5. App instalado (Ã­cone na tela inicial)
6. Pede permissÃ£o para notificaÃ§Ãµes
7. UsuÃ¡rio concede permissÃ£o
8. Frontend cria subscription (VAPID)
9. Subscription enviada para backend (POST /api/notifications/subscribe)
10. Backend salva subscription no MongoDB
11. Quando novo agendamento: backend envia push notification
12. Service Worker recebe push event
13. NotificaÃ§Ã£o exibida no navegador

**Tempo mÃ©dio:** 30-60 segundos (depende do usuÃ¡rio)

---

## 5. IntegraÃ§Ãµes Externas

### 5.1 Z-API WhatsApp Business

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INTEGRAÃ‡ÃƒO: Z-API                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COMPONENTES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   Z-API       â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   Backend     â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   MongoDB      â”‚â”‚
â”‚  â”‚  (WhatsApp)   â”‚ Webhook â”‚  - webhookCtrlâ”‚         â”‚  - Mensagem    â”‚â”‚
â”‚  â”‚               â”‚         â”‚  - whatsappCtrlâ”‚         â”‚  - Conversa    â”‚â”‚
â”‚  â”‚               â”‚         â”‚  - agenteCtrl â”‚         â”‚  - Cliente     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FLUXO WEBHOOK:
1. Cliente envia mensagem WhatsApp â†’ Z-API
2. Z-API envia POST /webhook/whatsapp
   Body: {
     "phone": "351912345678",
     "message": "OlÃ¡",
     "timestamp": "2025-11-16T10:30:00Z"
   }
3. Backend processa via webhookController.js
4. Resposta enviada via sendZapiWhatsAppMessage()

ENDPOINTS Z-API UTILIZADOS:
- POST /send-text  (enviar mensagem)
- Webhook receiver (receber mensagens)

AUTENTICAÃ‡ÃƒO:
- ZAPI_INSTANCE_ID
- ZAPI_TOKEN
- Base URL: https://api.z-api.io/instances/{instance}/token/{token}

CORS:
- Whitelist: https://api.z-api.io

LIMITAÃ‡Ã•ES:
- Sem verificaÃ§Ã£o de signature (vulnerabilidade)
- Sem rate limiting Z-API
- Sem retry automÃ¡tico
```

---

### 5.2 OpenAI API (GPT-4o-mini)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INTEGRAÃ‡ÃƒO: OPENAI API                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COMPONENTES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   OpenAI      â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   Backend     â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   MongoDB      â”‚â”‚
â”‚  â”‚ GPT-4o-mini   â”‚   API   â”‚ - openaiHelperâ”‚         â”‚ - Conversa     â”‚â”‚
â”‚  â”‚               â”‚         â”‚ - agenteCtrl  â”‚         â”‚ - Cliente      â”‚â”‚
â”‚  â”‚               â”‚         â”‚ - functionDispâ”‚         â”‚                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FLUXO FUNCTION CALLING:
1. Mensagem cliente â†’ Backend
2. Backend carrega context (histÃ³rico + cliente data)
3. Call OpenAI Chat Completions:
   {
     "model": "gpt-4o-mini",
     "messages": [
       {
         "role": "system",
         "content": "[systemLaura.md]"
       },
       {
         "role": "user",
         "content": "Quero agendar drenagem"
       }
     ],
     "tools": [
       {
         "type": "function",
         "function": {
           "name": "create_appointment",
           "description": "Criar novo agendamento",
           "parameters": {...}
         }
       }
     ]
   }
4. OpenAI retorna:
   - Text response (mensagem para cliente)
   - Tool calls (aÃ§Ãµes a executar)
5. Backend executa tool calls via functionDispatcher
6. Retorna resultado para OpenAI (tool outputs)
7. OpenAI gera resposta final
8. Backend envia para cliente via Z-API

MODELS:
- gpt-4o-mini: Chatbot conversacional + Function Calling
- gpt-3.5-turbo: ClassificaÃ§Ã£o de intenÃ§Ã£o (fallback)

TOOLS (FUNCTIONS):
- create_client
- update_client_data
- create_appointment
- update_appointment (reagendar/cancelar)

AUTENTICAÃ‡ÃƒO:
- OPENAI_API_KEY (sk-proj-...)

CUSTOS (estimado):
- gpt-4o-mini: ~$0.15 / 1M tokens input, ~$0.60 / 1M tokens output
- MÃ©dia: ~500 tokens/conversa
- Custo mensal (100 conversas/dia): ~$5-10
```

---

### 5.3 Web Push Service (VAPID)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      INTEGRAÃ‡ÃƒO: WEB PUSH (VAPID)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COMPONENTES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Web Push     â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   Backend     â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   MongoDB      â”‚â”‚
â”‚  â”‚  Service      â”‚  VAPID  â”‚ - pushService â”‚         â”‚ - UserSub      â”‚â”‚
â”‚  â”‚ (Google FCM,  â”‚         â”‚ - notifCtrl   â”‚         â”‚                â”‚â”‚
â”‚  â”‚  Mozilla, etc)â”‚         â”‚               â”‚         â”‚                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                                                                â”‚
â”‚         â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚  Service      â”‚                                                       â”‚
â”‚  â”‚  Worker       â”‚                                                       â”‚
â”‚  â”‚  (Frontend)   â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FLUXO SUBSCRIPTION:
1. Frontend: serviceWorker.pushManager.subscribe({
     userVisibleOnly: true,
     applicationServerKey: VAPID_PUBLIC_KEY
   })
2. Retorna subscription: {
     endpoint: "https://fcm.googleapis.com/fcm/send/...",
     keys: {
       auth: "...",
       p256dh: "..."
     }
   }
3. Frontend: POST /api/notifications/subscribe
   Body: { userId: 'LAURA', endpoint, keys }
4. Backend salva em UserSubscription collection

FLUXO ENVIO:
1. Backend: pushService.sendPushNotification(userId, payload)
2. Busca subscription em MongoDB
3. Envia via web-push library:
   webpush.sendNotification(subscription, JSON.stringify(payload))
4. Push Service (FCM/Mozilla) entrega ao navegador
5. Service Worker recebe 'push' event
6. Exibe notificaÃ§Ã£o: self.registration.showNotification()

PAYLOAD STRUCTURE:
{
  "notification": {
    "title": "Novo Agendamento",
    "body": "JoÃ£o Silva - 10:00",
    "icon": "/icon-192x192.png",
    "badge": "/badge-72x72.png",
    "tag": "agendamento-123",
    "requireInteraction": true
  },
  "data": {
    "agendamentoId": "507f1f77bcf86cd799439011",
    "clienteNome": "JoÃ£o Silva",
    "tipo": "novo_agendamento",
    "url": "/agendamentos"
  }
}

AUTENTICAÃ‡ÃƒO (VAPID):
- VAPID_PUBLIC_KEY (compartilhado com frontend)
- VAPID_PRIVATE_KEY (backend apenas)
- VAPID_SUBJECT (mailto:support@laurasaas.com)

GERAÃ‡ÃƒO DE KEYS:
node generate-vapid.js

PROVIDERS:
- Google FCM (Chrome, Edge)
- Mozilla Push (Firefox)
- Apple Push (Safari - iOS 16.4+)
- Microsoft Push (Edge)

TTL (Time to Live):
- Default: 28 dias
- ConfigurÃ¡vel por notificaÃ§Ã£o
```

---

### 5.4 MongoDB Atlas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       INTEGRAÃ‡ÃƒO: MONGODB ATLAS                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CONFIGURAÃ‡ÃƒO:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  Cluster: projeto-agenda.5sar5yx.mongodb.net                            â”‚
â”‚  Database: lauraDB                                                       â”‚
â”‚  Driver: Mongoose 8.1.2                                                  â”‚
â”‚  Connection String:                                                      â”‚
â”‚    mongodb+srv://andredosreis:***@projeto-agenda.5sar5yx.mongodb.net/   â”‚
â”‚    lauraDB?retryWrites=true&w=majority&appName=projeto-agenda           â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COLLECTIONS:
- clientes          (documentos: ~50-200)
- agendamentos      (documentos: ~500-2000)
- pacotes           (documentos: ~10-20)
- schedules         (documentos: 7 - fixo)
- conversas         (documentos: ~50-200)
- usersubscriptions (documentos: 1-10)
- mensagens         (documentos: ~1000+)

ÃNDICES:
- clientes.telefone (unique)
- clientes.email (unique, sparse)
- agendamentos.dataHora (ascending)
- agendamentos.cliente (ascending)
- agendamentos.status (ascending)
- conversas.telefone (unique)
- usersubscriptions.endpoint (unique)

BACKUP:
- MongoDB Atlas automated backups (daily)
- Retention: 7 dias (tier grÃ¡tis)

MONITORAMENTO:
- Atlas Performance Advisor
- Slow Query Logs (>100ms)
- Connection pooling (default: 100)

SEGURANÃ‡A:
- IP Whitelist (configurado)
- Database User (andredosreis)
- SSL/TLS obrigatÃ³rio
```

---

### 5.5 Vercel (Deploy Frontend)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         INTEGRAÃ‡ÃƒO: VERCEL                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CONFIGURAÃ‡ÃƒO:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  Project: laura-saas-agenda                                              â”‚
â”‚  URL: https://laura-saas-agenda-mfqt.vercel.app                         â”‚
â”‚  Framework: Vite                                                         â”‚
â”‚  Build Command: npm run build                                            â”‚
â”‚  Output Directory: dist/                                                 â”‚
â”‚  Install Command: npm install                                            â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ENVIRONMENT VARIABLES:
- VITE_API_URL (backend URL)
- VITE_VAPID_PUBLIC_KEY (Web Push)

FEATURES:
- Auto-deploy (Git push â†’ deploy)
- Preview deployments (PRs)
- Edge Network (CDN global)
- Analytics (@vercel/speed-insights)
- HTTPS automÃ¡tico
- Custom domains (futuro)

BUILD TIME: ~1-2 minutos
DEPLOY TIME: ~30 segundos
```

---

## 6. DecisÃµes Arquiteturais

### 6.1 Por que Monolito (nÃ£o MicroserviÃ§os)?

**DecisÃ£o:** Monolito modular

**RazÃµes:**
- âœ… MVP: Velocidade de desenvolvimento
- âœ… Equipe pequena: Menos complexidade operacional
- âœ… Baixo trÃ¡fego inicial: NÃ£o justifica microserviÃ§os
- âœ… Deploy simplificado: Um servidor apenas
- âœ… Debugging mais fÃ¡cil: Stack trace completo

**Trade-offs:**
- âŒ Escalabilidade horizontal limitada
- âŒ Acoplamento entre mÃ³dulos
- âŒ Deploy all-or-nothing

**MigraÃ§Ã£o futura:** Quando atingir 10k+ usuÃ¡rios, considerar:
- MicroserviÃ§o de IA (Python + LangChain)
- MicroserviÃ§o de Mensageria (WhatsApp + Email)

---

### 6.2 Por que MongoDB (nÃ£o PostgreSQL)?

**DecisÃ£o:** MongoDB Atlas (NoSQL)

**RazÃµes:**
- âœ… Schema flexÃ­vel: Anamnese mÃ©dica (campos dinÃ¢micos)
- âœ… HistÃ³rico de conversas: Arrays aninhados (fÃ¡cil no Mongo)
- âœ… Mongoose ODM: ValidaÃ§Ãµes + middleware hooks
- âœ… Atlas grÃ¡tis: Tier generoso (512MB)
- âœ… Escalabilidade: Sharding nativo

**Trade-offs:**
- âŒ Sem transaÃ§Ãµes ACID complexas (limitado)
- âŒ Sem JOINs eficientes (populate = mÃºltiplas queries)

**Quando usar PostgreSQL:**
- TransaÃ§Ãµes financeiras crÃ­ticas
- RelatÃ³rios complexos com JOINs

---

### 6.3 Por que OpenAI direto (nÃ£o LangChain)?

**DecisÃ£o:** OpenAI SDK direto

**RazÃµes:**
- âœ… Simplicidade: Menos abstraÃ§Ã£o
- âœ… Controle total: Function calling customizado
- âœ… Performance: Menos overhead
- âœ… MVP: RÃ¡pido de implementar

**Trade-offs:**
- âŒ Sem memory management avanÃ§ado
- âŒ Sem orquestraÃ§Ã£o complexa (LangGraph)
- âŒ Vendor lock-in (OpenAI)

**MigraÃ§Ã£o futura:**
- LangChain.js para memory + RAG
- LangGraph para workflows complexos

---

### 6.4 Por que PWA (nÃ£o App Nativo)?

**DecisÃ£o:** Progressive Web App

**RazÃµes:**
- âœ… Cross-platform: Android + iOS + Desktop
- âœ… Sem stores: InstalaÃ§Ã£o direta
- âœ… Updates automÃ¡ticos: Service Worker
- âœ… Menor custo: Um codebase
- âœ… SEO: IndexÃ¡vel pelo Google

**Trade-offs:**
- âŒ Recursos nativos limitados (cÃ¢mera, NFC)
- âŒ Performance inferior (comparado a nativo)
- âŒ iOS: Suporte Web Push limitado (iOS 16.4+)

**Quando usar App Nativo:**
- Recursos avanÃ§ados (biometria, pagamentos in-app)
- Performance crÃ­tica (jogos, ediÃ§Ã£o de vÃ­deo)

---

## 7. Escalabilidade

### 7.1 Bottlenecks Atuais

#### 7.1.1 Database (MongoDB)
**Problema:**
- Sem Ã­ndices compostos
- Populate = N+1 queries

**SoluÃ§Ã£o:**
```javascript
// Criar Ã­ndices compostos
AgendamentoSchema.index({ cliente: 1, dataHora: -1 });
AgendamentoSchema.index({ status: 1, dataHora: 1 });

// Usar agregaÃ§Ã£o em vez de populate
const agendamentos = await Agendamento.aggregate([
  { $match: { status: 'Agendado' } },
  {
    $lookup: {
      from: 'clientes',
      localField: 'cliente',
      foreignField: '_id',
      as: 'clienteData'
    }
  },
  { $unwind: '$clienteData' }
]);
```

**Capacidade atual:** ~1.000 agendamentos/dia
**Capacidade alvo:** ~10.000 agendamentos/dia

---

#### 7.1.2 LLM (OpenAI)
**Problema:**
- Requests sÃ­ncronos
- Sem cache de respostas

**SoluÃ§Ã£o:**
```javascript
// Cache de respostas comuns (Redis)
const cachedResponse = await redis.get(`llm:${messageHash}`);
if (cachedResponse) return JSON.parse(cachedResponse);

// Fallback para Queue (Bull)
const llmQueue = new Queue('llm', process.env.REDIS_URL);
llmQueue.process(async (job) => {
  return await chatWithLaura(job.data.message);
});
```

**Capacidade atual:** ~50 conversas simultÃ¢neas
**Capacidade alvo:** ~500 conversas simultÃ¢neas

---

#### 7.1.3 CRON Jobs
**Problema:**
- Single-threaded
- Bloqueia event loop

**SoluÃ§Ã£o:**
```javascript
// Bull queue com workers
const lembretesQueue = new Queue('lembretes', process.env.REDIS_URL);

// Producer (CRON)
cron.schedule('0 19 * * *', async () => {
  const agendamentos = await buscarAgendamentosAmanha();
  for (const agendamento of agendamentos) {
    await lembretesQueue.add({ agendamentoId: agendamento._id });
  }
});

// Consumer (worker - pode ser escalado)
lembretesQueue.process(5, async (job) => { // 5 concurrent
  await enviarLembrete(job.data.agendamentoId);
});
```

**Capacidade atual:** ~100 lembretes/batch
**Capacidade alvo:** ~1.000 lembretes/batch

---

### 7.2 Roadmap de Escalabilidade

#### Fase 1: OtimizaÃ§Ãµes (0-100 clientes/dia)
- âœ… Ãndices MongoDB
- âœ… Mongoose .lean()
- âœ… Redis cache (KPIs)

#### Fase 2: Async Processing (100-500 clientes/dia)
- â³ Bull queue (WhatsApp + LLM)
- â³ Worker threads

#### Fase 3: Horizontal Scaling (500-2000 clientes/dia)
- â³ Load balancer (Nginx)
- â³ Multiple backend instances
- â³ Redis cluster

#### Fase 4: MicroserviÃ§os (2000+ clientes/dia)
- â³ MicroserviÃ§o IA (Python + LangChain)
- â³ MicroserviÃ§o Mensageria
- â³ API Gateway (Kong/Traefik)

---

## 8. SeguranÃ§a

### 8.1 Vulnerabilidades Atuais

#### ðŸ”´ CRÃTICO: Sem AutenticaÃ§Ã£o
**Problema:** APIs expostas publicamente
**Impacto:** Dados de clientes acessÃ­veis
**SoluÃ§Ã£o:** Implementar JWT (ver seÃ§Ã£o 11.1)

#### ðŸ”´ CRÃTICO: Dados LGPD sem Criptografia
**Problema:** Anamnese mÃ©dica em plain text
**Impacto:** ViolaÃ§Ã£o LGPD (multa atÃ© R$ 50mi)
**SoluÃ§Ã£o:** Criptografia em repouso (AES-256)

#### âš ï¸ IMPORTANTE: Webhook sem ValidaÃ§Ã£o
**Problema:** Z-API webhook aceita qualquer POST
**Impacto:** Spoofing de mensagens
**SoluÃ§Ã£o:** Verificar signature

#### âš ï¸ IMPORTANTE: Sem Rate Limiting
**Problema:** VulnerÃ¡vel a DDoS
**Impacto:** Downtime, custos elevados
**SoluÃ§Ã£o:** express-rate-limit

---

### 8.2 Checklist de SeguranÃ§a

```
â–¡ AutenticaÃ§Ã£o JWT
â–¡ HTTPS obrigatÃ³rio (produÃ§Ã£o)
â–¡ CORS configurado (whitelist)
â–¡ Rate limiting (100 req/15min)
â–¡ Input validation (Joi)
â–¡ SQL Injection protection (Mongoose ODM)
â–¡ XSS protection (React escape automÃ¡tico)
â–¡ CSRF protection (SameSite cookies)
â–¡ Secrets em .env (nÃ£o commitar)
â–¡ LGPD compliance (consent forms)
â–¡ Criptografia dados sensÃ­veis (AES-256)
â–¡ Webhook signature verification
â–¡ Logs de auditoria (who, what, when)
â–¡ Vulnerability scanning (npm audit)
â–¡ Dependency updates (Dependabot)
```

---

### 8.3 LGPD Compliance Roadmap

#### Fase 1: Consentimento
- [ ] Consent form no cadastro cliente
- [ ] Checkbox "Li e aceito a PolÃ­tica de Privacidade"
- [ ] Armazenar consentimento (timestamp + IP)

#### Fase 2: Direitos do Titular
- [ ] Endpoint "Exportar meus dados" (JSON)
- [ ] Endpoint "Deletar minha conta" (GDPR Right to be Forgotten)
- [ ] AnonimizaÃ§Ã£o de dados (substituir por hash)

#### Fase 3: SeguranÃ§a TÃ©cnica
- [ ] Criptografia em repouso (mongoose-field-encryption)
- [ ] Criptografia em trÃ¢nsito (HTTPS)
- [ ] Auditoria de acesso (logs)

#### Fase 4: GovernanÃ§a
- [ ] DPO (Data Protection Officer) - Laura
- [ ] RIPD (RelatÃ³rio de Impacto Ã  ProteÃ§Ã£o de Dados)
- [ ] PolÃ­tica de Privacidade atualizada
- [ ] Termos de Uso

---

## 9. Performance

### 9.1 MÃ©tricas Atuais

**Frontend (Lighthouse):**
- Performance: 85/100 âš ï¸
- Accessibility: 95/100 âœ…
- Best Practices: 90/100 âœ…
- SEO: 100/100 âœ…

**Backend:**
- Response time (p50): ~150ms âœ…
- Response time (p95): ~500ms âš ï¸
- Error rate: <0.1% âœ…

**Database:**
- Query time (avg): ~50ms âœ…
- Slow queries (>100ms): ~5% âš ï¸

---

### 9.2 OtimizaÃ§Ãµes Implementadas

âœ… TailwindCSS (CSS minificado)
âœ… Vite build (tree shaking)
âœ… Service Worker (cache assets)
âœ… Mongoose .lean() (parcial)
âœ… MongoDB Ã­ndices bÃ¡sicos

---

### 9.3 OtimizaÃ§Ãµes Pendentes

#### Frontend
- [ ] Code splitting (React.lazy)
- [ ] Image optimization (WebP, lazy loading)
- [ ] Font optimization (WOFF2, preload)
- [ ] Bundle analyzer (webpack-bundle-analyzer)
- [ ] CDN para assets (Cloudflare)

#### Backend
- [ ] Redis cache (KPIs, queries frequentes)
- [ ] MongoDB Ã­ndices compostos
- [ ] Compression middleware (gzip)
- [ ] HTTP/2 (Nginx)
- [ ] Connection pooling (Mongoose)

---

## 10. Monitoramento

### 10.1 Monitoramento Atual

âŒ Sem monitoramento estruturado

**Logs:**
- Morgan (HTTP requests)
- console.log (erros, debug)

---

### 10.2 Monitoramento Recomendado

#### 10.2.1 Application Monitoring

**Sentry** (Error Tracking)
```javascript
npm install @sentry/node

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0
});
```

**Winston** (Logging Estruturado)
```javascript
npm install winston

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

---

#### 10.2.2 Infrastructure Monitoring

**Prometheus + Grafana**
```javascript
npm install prom-client

const client = require('prom-client');
const register = new client.Registry();

// MÃ©tricas
const httpRequestDuration = new client.Histogram({
  name: 'http_request_duration_seconds',
  help: 'Duration of HTTP requests',
  labelNames: ['method', 'route', 'status_code']
});

// Endpoint /metrics
app.get('/metrics', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});
```

**Dashboards Grafana:**
- Requests/segundo
- Response time (p50, p95, p99)
- Error rate
- Database connections
- LLM latency
- WhatsApp delivery rate

---

#### 10.2.3 Alertas

**Configurar alertas para:**
- Error rate > 1%
- Response time p95 > 1s
- Database slow queries > 10%
- CRON job failures
- Disk space < 20%

---

## 11. PrÃ³ximos Passos

### Sprint 1 (7 dias) - CRÃTICO
1. âœ… DocumentaÃ§Ã£o completa (este arquivo)
2. â³ Implementar JWT authentication
3. â³ Rate limiting
4. â³ .env.example

### Sprint 2-4 (30 dias) - IMPORTANTE
1. â³ Redis cache
2. â³ Bull queue
3. â³ Sentry + Winston
4. â³ LGPD compliance

### Roadmap (90 dias) - DESEJÃVEL
1. â³ MicroserviÃ§o IA
2. â³ Financeiro completo
3. â³ Analytics avanÃ§ado
4. â³ Mobile app

---

**FIM DA DOCUMENTAÃ‡ÃƒO DE ARQUITETURA**

**Ãšltima AtualizaÃ§Ã£o:** 16 de Novembro de 2025
**VersÃ£o:** 1.0.0
**Autor:** AndrÃ© dos Reis
